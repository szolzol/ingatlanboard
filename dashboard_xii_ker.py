#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ENHANCED XII. KER√úLETI DASHBOARD GENER√ÅTOR
==========================================

Az enhanced lok√°ci√≥ rendszerrel √∫jra gener√°lja a XII. ker√ºleti dashboardot
pontosabb lok√°ci√≥ kategoriz√°l√°ssal √©s Google Maps integr√°ci√≥ lehet≈ës√©g√©vel.
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np
import os
import re
from collections import Counter
from datetime import datetime

# Streamlit konfigur√°ci√≥
st.set_page_config(
    page_title="üè† XII. Ker√ºlet - Enhanced Ingatlan Dashboard", 
    page_icon="üè†", 
    layout="wide"
)

# ==== ENHANCED DASHBOARD MAIN ====
def main():
    """F≈ëfunkci√≥ - Enhanced XII. ker√ºleti dashboard"""
    
    # Dashboard c√≠me
    st.title("üè† XII. Ker√ºlet Ingatlan Dashboard - Enhanced Lok√°ci√≥ Rendszer")
    st.markdown("---")
    
    # Adatok bet√∂lt√©se
    df = load_data()
    if df is None or len(df) == 0:
        st.error("‚ùå Nincs XII. ker√ºleti adat!")
        return
    
    # Enhanced lok√°ci√≥ oszlopok ellen≈ërz√©se
    enhanced_columns = ['enhanced_keruleti_resz', 'lokacio_konfidencia', 'lokacio_elemzesi_modszer']
    has_enhanced = all(col in df.columns for col in enhanced_columns)
    
    if has_enhanced:
        st.success(f"‚úÖ Enhanced lok√°ci√≥ adatok bet√∂ltve - {len(df)} rekord")
        st.info("üó∫Ô∏è Ez a dashboard az Enhanced Lok√°ci√≥ Rendszert haszn√°lja pontosabb kategoriz√°l√°shoz")
    else:
        st.warning("‚ö†Ô∏è Enhanced lok√°ci√≥ adatok nem tal√°lhat√≥k - alap√©rtelmezett dashboard")
    
    # Alap statisztik√°k
    show_basic_stats(df)
    
    if has_enhanced:
        # Enhanced lok√°ci√≥ elemz√©sek
        show_enhanced_location_analysis(df)
    
    # √Årelemz√©sek
    show_price_analysis(df)
    
    # Sz√∂veganal√≠zis
    if 'netto_szoveg_pont' in df.columns:
        show_text_analysis(df)
    
    # R√©szletes adatok
    show_detailed_data(df)

def load_data():
    """XII. ker√ºleti adatok bet√∂lt√©se"""
    
    # Keres√©s a XII. ker√ºleti f√°jlokra
    xii_files = [f for f in os.listdir('.') if 'xii_ker' in f.lower() and f.endswith('.csv')]
    
    if not xii_files:
        return None
    
    # Leg√∫jabb f√°jl kiv√°laszt√°sa
    latest_file = max(xii_files, key=os.path.getmtime)
    
    try:
        # T√∂bbf√©le bet√∂lt√©si k√≠s√©rlet
        separators = ['|', ';', ',']
        for sep in separators:
            try:
                df = pd.read_csv(latest_file, sep=sep, encoding='utf-8', on_bad_lines='skip')
                if len(df.columns) > 10:
                    st.info(f"üìÇ Adatforr√°s: {latest_file} (sep='{sep}')")
                    return df
            except:
                continue
                
        return None
        
    except Exception as e:
        st.error(f"Adatbet√∂lt√©si hiba: {e}")
        return None

def show_basic_stats(df):
    """Alapstatisztik√°k megjelen√≠t√©se"""
    
    st.subheader("üìä Alapstatisztik√°k")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("√ñsszes ingatlan", len(df))
    
    with col2:
        if 'teljes_ar' in df.columns:
            avg_price = df['teljes_ar'].dropna().apply(extract_price_number).mean()
            if pd.notna(avg_price):
                st.metric("√Åtlag√°r", f"{avg_price:.1f}M Ft")
            else:
                st.metric("√Åtlag√°r", "N/A")
        else:
            st.metric("√Åtlag√°r", "N/A")
    
    with col3:
        if 'terulet' in df.columns:
            avg_area = df['terulet'].dropna().apply(extract_area_number).mean()
            if pd.notna(avg_area):
                st.metric("√Åtlag ter√ºlet", f"{avg_area:.0f} m¬≤")
            else:
                st.metric("√Åtlag ter√ºlet", "N/A")
        else:
            st.metric("√Åtlag ter√ºlet", "N/A")
    
    with col4:
        if 'nm_ar' in df.columns:
            avg_sqm_price = df['nm_ar'].dropna().apply(extract_sqm_price).mean()
            if pd.notna(avg_sqm_price):
                st.metric("√Åtlag m¬≤ √°r", f"{avg_sqm_price:.0f} Ft/m¬≤")
            else:
                st.metric("√Åtlag m¬≤ √°r", "N/A")
        else:
            st.metric("√Åtlag m¬≤ √°r", "N/A")

def show_enhanced_location_analysis(df):
    """Enhanced lok√°ci√≥ elemz√©sek megjelen√≠t√©se"""
    
    st.subheader("üó∫Ô∏è Enhanced Lok√°ci√≥ Elemz√©s")
    
    if 'enhanced_keruleti_resz' not in df.columns:
        st.warning("Enhanced lok√°ci√≥ adatok nem tal√°lhat√≥k")
        return
    
    # Ker√ºleti r√©szek megoszl√°sa
    col1, col2 = st.columns([2, 1])
    
    with col1:
        district_counts = df['enhanced_keruleti_resz'].value_counts()
        
        fig = px.pie(
            values=district_counts.values, 
            names=district_counts.index,
            title="XII. Ker√ºleti R√©szek Megoszl√°sa (Enhanced Rendszer)"
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        st.write("**Ker√ºleti r√©szek:**")
        for district, count in district_counts.items():
            percentage = (count / len(df)) * 100
            st.write(f"‚Ä¢ {district}: {count} db ({percentage:.1f}%)")
    
    # Lok√°ci√≥ konfidencia elemz√©s
    if 'lokacio_konfidencia' in df.columns:
        st.subheader("üéØ Lok√°ci√≥ Konfidencia Elemz√©s")
        
        col1, col2 = st.columns(2)
        
        with col1:
            fig = px.histogram(
                df, 
                x='lokacio_konfidencia',
                title="Lok√°ci√≥ Konfidencia Eloszl√°s",
                nbins=20
            )
            st.plotly_chart(fig, use_container_width=True)
        
        with col2:
            high_conf = (df['lokacio_konfidencia'] > 0.7).sum()
            medium_conf = ((df['lokacio_konfidencia'] > 0.4) & (df['lokacio_konfidencia'] <= 0.7)).sum()
            low_conf = (df['lokacio_konfidencia'] <= 0.4).sum()
            
            st.write("**Konfidencia kateg√≥ri√°k:**")
            st.write(f"‚Ä¢ Magas (>0.7): {high_conf} db")
            st.write(f"‚Ä¢ K√∂zepes (0.4-0.7): {medium_conf} db") 
            st.write(f"‚Ä¢ Alacsony (‚â§0.4): {low_conf} db")
    
    # Elemz√©si m√≥dszerek megoszl√°sa
    if 'lokacio_elemzesi_modszer' in df.columns:
        method_counts = df['lokacio_elemzesi_modszer'].value_counts()
        
        fig = px.bar(
            x=method_counts.index,
            y=method_counts.values,
            title="Lok√°ci√≥ Elemz√©si M√≥dszerek Megoszl√°sa"
        )
        st.plotly_chart(fig, use_container_width=True)

def show_price_analysis(df):
    """√Årelemz√©sek megjelen√≠t√©se"""
    
    st.subheader("üí∞ √Årelemz√©sek")
    
    if 'teljes_ar' not in df.columns:
        st.warning("√År adatok nem tal√°lhat√≥k")
        return
    
    # √Årak kinyer√©se √©s tiszt√≠t√°sa
    df_price = df.copy()
    df_price['ar_szam'] = df_price['teljes_ar'].apply(extract_price_number)
    df_price = df_price.dropna(subset=['ar_szam'])
    
    if len(df_price) == 0:
        st.warning("Nincs feldolgozhat√≥ √°r adat")
        return
    
    col1, col2 = st.columns(2)
    
    with col1:
        # √År eloszl√°s
        fig = px.histogram(
            df_price, 
            x='ar_szam',
            title="√Årak Eloszl√°sa",
            nbins=20
        )
        fig.update_xaxes(title="√År (milli√≥ Ft)")
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Enhanced ker√ºleti r√©szek szerinti √°rak (ha van)
        if 'enhanced_keruleti_resz' in df_price.columns:
            fig = px.box(
                df_price,
                x='enhanced_keruleti_resz', 
                y='ar_szam',
                title="√Årak Ker√ºleti R√©szek Szerint"
            )
            fig.update_xaxes(tickangle=45)
            fig.update_yaxes(title="√År (milli√≥ Ft)")
            st.plotly_chart(fig, use_container_width=True)

def show_text_analysis(df):
    """Sz√∂veganal√≠zis megjelen√≠t√©se"""
    
    st.subheader("üìù Sz√∂veganal√≠zis")
    
    if 'netto_szoveg_pont' not in df.columns:
        st.warning("Sz√∂veganal√≠zis adatok nem tal√°lhat√≥k")
        return
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Nett√≥ sz√∂vegpontok eloszl√°sa
        fig = px.histogram(
            df,
            x='netto_szoveg_pont', 
            title="Nett√≥ Sz√∂vegpontok Eloszl√°sa",
            nbins=20
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Top kateg√≥ri√°k
        if 'enhanced_keruleti_resz' in df.columns:
            avg_scores = df.groupby('enhanced_keruleti_resz')['netto_szoveg_pont'].mean().sort_values(ascending=False)
            
            fig = px.bar(
                x=avg_scores.index,
                y=avg_scores.values,
                title="√Åtlag Sz√∂vegpontok Ker√ºleti R√©szek Szerint"
            )
            fig.update_xaxes(tickangle=45)
            st.plotly_chart(fig, use_container_width=True)

def show_detailed_data(df):
    """R√©szletes adatok megjelen√≠t√©se"""
    
    st.subheader("üîç R√©szletes Adatok")
    
    # Sz≈±r≈ëk
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if 'enhanced_keruleti_resz' in df.columns:
            districts = ['√ñsszes'] + list(df['enhanced_keruleti_resz'].unique())
            selected_district = st.selectbox("Ker√ºleti r√©sz", districts)
        else:
            selected_district = '√ñsszes'
    
    with col2:
        min_price = st.number_input("Min √°r (M Ft)", value=0, min_value=0)
    
    with col3:
        max_price = st.number_input("Max √°r (M Ft)", value=2000, min_value=0)
    
    # Sz≈±r√©s alkalmaz√°sa
    filtered_df = df.copy()
    
    if selected_district != '√ñsszes' and 'enhanced_keruleti_resz' in df.columns:
        filtered_df = filtered_df[filtered_df['enhanced_keruleti_resz'] == selected_district]
    
    if 'teljes_ar' in df.columns:
        filtered_df['ar_szam'] = filtered_df['teljes_ar'].apply(extract_price_number)
        filtered_df = filtered_df[
            (filtered_df['ar_szam'].between(min_price, max_price)) | 
            (filtered_df['ar_szam'].isna())
        ]
    
    st.write(f"**Sz≈±rt eredm√©nyek:** {len(filtered_df)} ingatlan")
    
    # Megjelen√≠tend≈ë oszlopok kiv√°laszt√°sa
    display_columns = ['cim', 'teljes_ar', 'terulet']
    if 'enhanced_keruleti_resz' in filtered_df.columns:
        display_columns.append('enhanced_keruleti_resz')
    if 'lokacio_konfidencia' in filtered_df.columns:
        display_columns.append('lokacio_konfidencia')
    
    # Csak l√©tez≈ë oszlopok megtart√°sa
    display_columns = [col for col in display_columns if col in filtered_df.columns]
    
    # T√°bl√°zat megjelen√≠t√©se
    if display_columns:
        st.dataframe(filtered_df[display_columns].head(50), use_container_width=True)

# ==== SEG√âDF√úGGV√âNYEK ====

def extract_price_number(price_str):
    """√År sz√∂vegb≈ël sz√°m kinyer√©se (milli√≥ Ft-ban)"""
    if pd.isna(price_str) or price_str == '':
        return np.nan
    
    price_str = str(price_str).lower().replace(' ', '')
    
    # Milli√°rd -> milli√≥ konverzi√≥
    if 'mrd' in price_str or 'milli√°rd' in price_str:
        numbers = re.findall(r'[\d,]+', price_str.replace(',', '.'))
        if numbers:
            return float(numbers[0]) * 1000
    
    # Milli√≥ kinyer√©se
    numbers = re.findall(r'[\d,]+', price_str.replace(',', '.'))
    if numbers:
        return float(numbers[0])
    
    return np.nan

def extract_area_number(area_str):
    """Ter√ºlet sz√∂vegb≈ël sz√°m kinyer√©se (m¬≤-ben)"""
    if pd.isna(area_str):
        return np.nan
    
    numbers = re.findall(r'\d+', str(area_str))
    if numbers:
        return float(numbers[0])
    
    return np.nan

def extract_sqm_price(sqm_str):
    """M¬≤ √°r kinyer√©se"""
    if pd.isna(sqm_str):
        return np.nan
    
    numbers = re.findall(r'[\d ]+', str(sqm_str).replace(' ', ''))
    if numbers:
        return float(numbers[0])
    
    return np.nan

if __name__ == "__main__":
    main()
